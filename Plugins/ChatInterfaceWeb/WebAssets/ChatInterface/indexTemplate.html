<head>
    <title>Chat Interface ICAN.SIC</title>
</head>

<link href="css/RecordingButton.css" rel="stylesheet" />

<script src="Scripts/jquery-1.6.4.min.js"></script>
<script src="Scripts/jquery.signalR-2.0.3.min.js"></script>
<script src="http://{host}:{port}/signalr/hubs"></script>
<script src="js/RecordingButton.js"></script>
<script src="js/TextToSpeechChrome.js"></script>
<script type="text/javascript">
    //$(function () {
    //Set the hubs URL for the connection
    $.connection.hub.url = "http://{host}:{port}/signalr";

    var chat = $.connection.chatInterfaceSignalRHub;
    chat.client.addBotMessage = function (message) {
        addUIBotMessage(message);
    };
    chat.client.addUserMessage = function (message) {
        addUIUserMessage(message);
    };
    chat.client.addChatMessage = function (htmlContent) {
        //addUIUserMessage(htmlContent);
        addUIChatMessage(htmlContent);
    };
    $.connection.hub.start().done(function () {
        $('#sendmessage').click(function () {
            chat.server.addBotMessage($('#message').val());
        });
    });
	
	
</script>

<style>
    body {
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
        background: url("background.jpg");
    }

    .previewImage{
        width: 600px;
    }

    .speech-divider {
        padding: 5px 5px;
    }

    .speech-wrapper {
        padding: 30px 40px;
    }

    .speech-wrapper .bubble {
        width: 1450px;
        height: auto;
        display: block;
        background: #f5f5f5;
        border-radius: 4px;
        box-shadow: 2px 8px 5px #000;
        position: relative;
        margin: 0 0 25px;
    }

    .speech-wrapper .bubble.alt {
        margin: 0 0 0 60px;
    }

    .speech-wrapper .bubble .txt {
        padding: 8px 55px 8px 14px;
        margin-top: 20px;
    }

    .speech-wrapper .bubble .txt .name {
        font-weight: 600;
        font-size: 12px;
        margin: 0 0 4px;
        color: #3498db;
    }

    .speech-wrapper .bubble .txt .name span {
        font-weight: normal;
        color: #b3b3b3;
    }

    .speech-wrapper .bubble .txt .name.alt {
        color: #2ecc71;
    }

    .speech-wrapper .bubble .txt .message {
        font-size: 12px;
        margin: 0;
        color: #2b2b2b;
    }

    .speech-wrapper .bubble .txt .timestamp {
        font-size: 11px;
        position: absolute;
        bottom: 8px;
        right: 10px;
        text-transform: uppercase;
        color: #999;
    }

    .speech-wrapper .bubble .bubble-arrow {
        position: absolute;
        width: 0;
        bottom: 42px;
        left: -16px;
        height: 0;
    }

    .speech-wrapper .bubble .bubble-arrow.alt {
        right: -2px;
        bottom: 40px;
        left: auto;
    }

    .speech-wrapper .bubble .bubble-arrow:after {
        content: "";
        position: absolute;
        border: 0 solid transparent;
        border-top: 9px solid #f5f5f5;
        border-radius: 0 20px 0;
        width: 15px;
        height: 30px;
        transform: rotate(145deg);
    }

    .speech-wrapper .bubble .bubble-arrow.alt:after {
        transform: rotate(45deg) scaleY(-1);
    }






    input[type="text"] {
        box-sizing: border-box;
        width: 100%;
        height: calc(3em + 0px);
        margin: 0 0 0em;
        padding: 1em;
        border: 1px solid #ccc;
        background: #fff;
        resize: none;
        outline: none;
        font-size: 12px;
    }

    #userInputEnter {
        position: fixed;
        right: 0px;
        bottom: 0px;
        padding: 0px;
        margin: 3px;
        border-style: solid;
        border-color: white white white #202020;
        outline: none;
        box-sizing: border-box;
        width: 20px;
        height: 20px;
        border-width: 15px 0px 15px 20px;
    }

    ::-webkit-input-placeholder {
        font-style: italic;
    }

    #userInputBox {
        position: fixed;
        bottom: 0px;
        left: 0px;
    }
	
	#toolbar {
		height: 60px;
	}
	
	#toolbar-gap {
		height: 60px;
	}
	
	
@media screen and (max-width: 992px) {
	
	#userInputEnter{
		border-width: 26px 0px 26px 38px;
	}
	
	#userInputBox {
        height: 60px;
		font-size: 25px;
    }
	
    .previewImage{
        width: 400px;
    }

	.speech-wrapper .bubble .txt .name.alt {
        font-size: 23px;
    }
	
	.speech-wrapper .bubble .txt .name {
		font-size: 23px;
	}
	
	.speech-wrapper .bubble .txt .message {
        font-size: 18px;
	}
	
	.speech-wrapper .bubble .txt .timestamp {
		font-size: 15px;
	}
	
	#toolbar {
		height: 90px;
	}
	
	#toolbar-gap {
		height: 90px;
	}
}

	// Checkbox styling
	
	#voiceResponseCheckbox{
	}
	
	[type="checkbox"]:checked,
	[type="checkbox"]:not(:checked) {
		position: absolute;
		-webkit-appearance: none;
		left: -9999px;
	}
	[type="checkbox"]:checked + label,
	[type="checkbox"]:not(:checked) + label
	{
		position: relative;
		padding-left: 28px;
		cursor: pointer;
		line-height: 20px;
		display: inline-block;
		color: #ccc;
		font-style: italic;
		font-size: 12px;
		bottom: 9px;
		border-radius: 20px;
		
		background: rgba(0, 0, 0, 0.6);
		text-align: right;
		padding-right: 15px;
		padding-bottom: 7px;
		padding-top: 7px;
	}
	[type="checkbox"]:checked + label:before,
	[type="checkbox"]:not(:checked) + label:before {
		content: '';
		position: absolute;
		left: 0;
		top: 0;
		width: 10px;
		height: 10px;
		border: 6px solid #fff;
		border-radius: 20px;
		background: #000;
		
		padding: 7px;
	}
	[type="checkbox"]:checked + label:after,
	[type="checkbox"]:not(:checked) + label:after {
		content: '';
		width: 8px;
		height: 8px;
		background: #00bb00;
		border-radius: 20px;
		position: absolute;
		top: 5px;
		left: 5px;
		padding: 9px;
		-webkit-transition: all 0.2s ease;
		transition: all 0.5s ease;
	}
	[type="checkbox"]:not(:checked) + label:after {\
		opacity: 0;
		-webkit-transform: scale(0);
		transform: scale(0);
	}
	[type="checkbox"]:checked + label:after {
		opacity: 1;
		-webkit-transform: scale(1);
		transform: scale(1);
	}
</style>

<script>
	
	var lastFlagForSpeechUsed = false;
	var informationTypes = ["USER-MACHINE MESSAGE", "MACHINE MESSAGE"];
	
	/* Speech output - Speak respons */
	function updateVoiceResponseCheckboxUI(){
		if (lastFlagForSpeechUsed && !$('#voiceResponseCheckbox').is(':checked'))
			$('#voiceResponseCheckbox').prop('checked', true);
		else if (!lastFlagForSpeechUsed && $('#voiceResponseCheckbox').is(':checked'))
			$('#voiceResponseCheckbox').prop('checked', false);
	}
	
	function setAllFlagsToFalse(){
		lastFlagForSpeechUsed = false;
		updateVoiceResponseCheckboxUI();
	}
	
	function extractTextFromHtmlContent(htmlContent) {
		var html = htmlContent;
		var div = document.createElement("div");
		div.innerHTML = html;
		var text = div.textContent || div.innerText || "";
		text = text.trim();
		
		return text;
	}
	
	function getInformationTypePrefix(htmlContent) {
		var text = extractTextFromHtmlContent(htmlContent);
		
		if (text == "")
			return "";
		
		for (i in informationTypes) {
			if (text.startsWith(informationTypes[i]))
				return informationTypes[i];
		}
		
		return "";
	}
	
    function updateGUI(width) {
        var bubbleList = document.getElementsByClassName("bubble");

        for (var i = 0; i < bubbleList.length; i++) {
            bubbleList[i].style.width = (width - 150) + "px";
        }

        window.scrollTo(0, document.body.scrollHeight);
    }

    window.onresize = function (event) {
        updateGUI(event.srcElement.innerWidth);
    };

    function addUIBotMessage(message) {
        //if (message.toString().trim() == "")
            //message = '<i style="color: grey;">[Acknowledged]</i>';
			
        var botMessageTemplate = createElementFromHTML('<div class="bubble">\
		<div class="txt">\
		  <p class="name">Interface</p>\
		  <p class="message" style="\
				background: #cde7ff;\
				border-radius: 5px;\
				padding: 5px;\
			">' + message + '</p>\
		  <span class="timestamp">' + (new Date()).getHours() + ':' + (new Date()).getMinutes() + '</span>\
		</div>\
		<div class="bubble-arrow"></div>\
		</div>');
		
		if (message.toString().trim() == "") {
            message = '<i style="color: grey;">[Acknowledged]</i>';
			
			botMessageTemplate = createElementFromHTML('<div class="bubble">\
			<div class="txt">\
			  <p class="name">Interface</p>\
			  <p class="message">' + message + '</p>\
			  <span class="timestamp">' + (new Date()).getHours() + ':' + (new Date()).getMinutes() + '</span>\
			</div>\
			<div class="bubble-arrow"></div>\
			</div>');
		}
		
        document.getElementById("container").appendChild(botMessageTemplate);
        updateGUI(window.visualViewport.width);
		
		botResponseCallback(message);
    }

    function addUIUserMessage(message) {
        var userMessageTemplate = createElementFromHTML('<div class="bubble alt">\
		<div class="txt">\
		  <p class="name alt">Me<span> </span></p>\
		  <p class="message" style="\
				background: #2ecc7147;\
				border-radius: 5px;\
				padding: 5px;\
			">' + message + '</p>\
		  <span class="timestamp">' + (new Date()).getHours() + ':' + (new Date()).getMinutes() + '</span>\
		</div>\
		<div class="bubble-arrow alt"></div>\
	  </div>');
        document.getElementById("container").appendChild(userMessageTemplate);
        updateGUI(window.visualViewport.width);
    }

    function addUIChatMessage(htmlContent) {
		
		infoType = getInformationTypePrefix(htmlContent);
		message = extractTextFromHtmlContent(htmlContent).substring(infoType.length).trim();
		
		console.log('addUIChatMessage: HtmlContent: ' + htmlContent); 
		
        botMessageTemplate = createElementFromHTML('<div class="bubble">\
			<div class="txt">\
			  <p class="name">Information</p>\
			  ' + htmlContent + '\
			  <span class="timestamp">' + (new Date()).getHours() + ':' + (new Date()).getMinutes() + '</span>\
			</div>\
			<div class="bubble-arrow"></div>\
			</div>');
        
		if (message != '' && infoType == "USER-MACHINE MESSAGE") {
			botMessageTemplate = createElementFromHTML('<div class="bubble">\
			<div class="txt">\
			  <p class="name">Information</p>\
			  <p style="font-size: 12px;">' + infoType + '</p>\
			  <p class="message" style="\
				background: #cde7ff;\
				border-radius: 5px;\
				padding: 5px;\
				">' + message + '</p>\
			  <span class="timestamp">' + (new Date()).getHours() + ':' + (new Date()).getMinutes() + '</span>\
			</div>\
			<div class="bubble-arrow"></div>\
			</div>');
		}
		
		if (htmlContent.toString().trim() == "") {
            htmlContent = '<i style="color: grey;">[Acknowledged]</i>';
			
			botMessageTemplate = createElementFromHTML('<div class="bubble">\
			<div class="txt">\
			  <p class="name">Information</p>\
			  ' + htmlContent + '\
			  <span class="timestamp">' + (new Date()).getHours() + ':' + (new Date()).getMinutes() + '</span>\
			</div>\
			<div class="bubble-arrow"></div>\
			</div>');
		}
		
		// Speech response
		else if (lastFlagForSpeechUsed){
			console.log('addUIChatMessage, InfoType: "' + infoType + '", LastFlagForSpeechUsed: ' + lastFlagForSpeechUsed);
			
			if (infoType == "USER-MACHINE MESSAGE") {
				console.log('addUIChatMessage, Say()');
				speechResponseText = extractTextFromHtmlContent(htmlContent).substring(infoType.length);
				
				Say(1, speechResponseText);
			}
		}
		
        document.getElementById("container").appendChild(botMessageTemplate);
        updateGUI(window.visualViewport.width);
    }

    window.addEventListener('load', function () {
        updateGUI(window.visualViewport.width);
    }, true);

    function sendUserResponseToServer(message) {
        chat.server.processUserMessage(message);
    }
	
	// If modification is done to initialization below 2 statements
	// modify both for working code
	PastUserInput = [""]
	PastInputIndex = 0
	
	function DecreasePastInputIndex() {
		PastInputIndex--;
		
		if (PastInputIndex < 0)
			PastInputIndex = 0;
	}
	
	function IncreasePastInputIndex() {
		PastInputIndex++;
		
		if (PastUserInput.length == PastInputIndex)
			PastInputIndex--;
	}
	
    function keyPressed(event) {
        if (event.key == "Enter" && document.getElementById("userInputBox").value.trim() != "") {
            sendUserResponseToServer(document.getElementById("userInputBox").value);
			
			if (PastInputIndex == PastUserInput.length - 1) {
				PastUserInput.splice(PastUserInput.length - 1, 0, document.getElementById("userInputBox").value);
				IncreasePastInputIndex();
			}
			
            document.getElementById("userInputBox").value = "";
            document.getElementById("userInputBox").focus();
        }
		else if (event.key == "ArrowUp") {
			console.log("Up");
			DecreasePastInputIndex();
			document.getElementById("userInputBox").value = PastUserInput[PastInputIndex];
		}
		else if (event.key == "ArrowDown") {
			console.log("Down");
			IncreasePastInputIndex();
			document.getElementById("userInputBox").value = PastUserInput[PastInputIndex];
		}
    }

    function userInputEnterPressed(event) {
        if (document.getElementById("userInputBox").value.trim() != "") {
            sendUserResponseToServer(document.getElementById("userInputBox").value);
            document.getElementById("userInputBox").value = "";
            document.getElementById("userInputBox").focus();
        }
    }
	
	function userInputKeyUp(event) {
		console.log(event);
	}

    function createElementFromHTML(htmlString) {
        var div = document.createElement('div');
        div.innerHTML = htmlString.trim();

        return div.firstChild;
    }
	
	
	
	// Google speech recognition
	
	var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
	var recognition = new SpeechRecognition();
	
	function initSpeechRecognition(){
		recognition.lang = 'en-US';
		recognition.interimResults = false;
		
		recognition.addEventListener('result', (e) => {
			last = e.results.length - 1;
			text = e.results[last][0].transcript;
			
			//confidence = e.results[0][0].confidence;
			
			document.getElementById("userInputBox").value = text;
			userInputEnterPressed(null);
			document.getElementById("userInputBox").blur();
			
			lastFlagForSpeechUsed = true;
			updateVoiceResponseCheckboxUI();
			
			updateUIEndRecording();
		});
		
		recognition.speechend = function() {
			updateUIEndRecording();
		}
		
		recognition.onend = function() {
			updateUIEndRecording();
		}
		
		recognition.onerror = function(e) {
			updateUIEndRecording();
		}
	}
	
	function startSpeechRecognition(){
		recognition.start();
		updateUIStartRecording();
	}
	
	function botResponseCallback(content){
		console.log('botResponseCallback, LastFlagForSpeechUsed: ' + lastFlagForSpeechUsed);
		if (lastFlagForSpeechUsed){
			Say(1, content);
		}
	}
	
	
	
	$(document).ready(function(){
		// Init
		
		initSpeechRecognition();
		VoiceInit();
		
		updateVoiceResponseCheckboxUI();
	
	
		$(document).keydown(function(evt) {
			var tag = evt.target.tagName.toLowerCase();
			if (tag != 'input' && tag != 'textarea') {
				evt = evt || window.event;
				
				switch(evt.keyCode){
					case 83: 
						startSpeechRecognition();
						break;
				}
			}
		});
		
		
		console.log("Press 's' to start speech recognition");
		
		
		$('#recButton').addClass("notRec");
		
		
		$('#recButton').click(function(){
			if (recordingRunning){
				recordingRunning = false;
			}
			else{
				startSpeechRecognition();
			}
		});
		
		
		// Speech output - Speak response
		
		$('#voiceResponseCheckbox').change(function(e) {
			if($(this).is(':checked')) {
				lastFlagForSpeechUsed = true;
			}
			else{
				lastFlagForSpeechUsed = false;
			}
		});
	});

</script>

<div id="container" class="speech-wrapper">

</div>

<div id="toolbar" style="position: fixed; bottom: 50px;">
	<button id="recButton"></button>
	
	<input type="checkbox" id="voiceResponseCheckbox" checked>
    <label for="voiceResponseCheckbox">&nbsp;&nbsp;&nbsp; Speak response</label>	
	
</div>

<div id="toolbar-gap"></div>

<input value="" type='text' id="userInputBox" onkeyup="keyPressed(event)" placeholder="User message">
<input type="button" value="" id="userInputEnter" onclick="userInputEnterPressed(event)" />

<script>
	var recordingRunning = false;
	
	
	function updateUIStartRecording(){
		StartRecordingAnimation('#recButton');
		recordingRunning = true;
	}
	
	function updateUIEndRecording(){
		EndRecordingAnimation('#recButton');
		recordingRunning = false;
	}
</script>


